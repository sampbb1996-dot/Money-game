<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title></title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #030303;
    width: 100%;
    height: 100%;
    overflow: hidden;
    touch-action: manipulation;
  }
  canvas { display: block; }
</style>
</head>
<body>
<canvas id="c"></canvas>

<script>
/* ===============================
   OWNER EXCLUSION (YOU)
================================ */
if (!localStorage.getItem("mg_owner")) {
  localStorage.setItem("mg_owner", "true");
}
const IS_OWNER = localStorage.getItem("mg_owner") === "true";

/* ===============================
   CANVAS SETUP
================================ */
const canvas = document.getElementById("c");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
addEventListener("resize", resize);
resize();

/* ===============================
   FIELD NOISE
================================ */
const noise = [];
for (let i = 0; i < 180; i++) {
  noise.push({
    x: Math.random(),
    y: Math.random(),
    a: Math.random() * 0.04 + 0.01,
    w: Math.random() * 2 + 0.5
  });
}

/* ===============================
   GAME STATE
================================ */
let t = 0;
let armed = false;
let lastStimulus = performance.now();
let reactionWindow = 420;

let counted = false;

/* ===============================
   SHARED COUNTER (FREE)
================================ */
const COUNT_NS = "money-game";
const COUNT_KEY = "players";

/* ===============================
   DRAW LOOP
================================ */
function draw(time) {
  ctx.fillStyle = "rgba(3,3,3,0.18)";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  for (const p of noise) {
    p.a += (Math.random() - 0.5) * 0.002;
    p.a = Math.max(0.01, Math.min(0.05, p.a));

    ctx.strokeStyle = `rgba(240,240,240,${p.a})`;
    ctx.lineWidth = p.w;

    const x = p.x * canvas.width;
    const y = p.y * canvas.height;

    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(
      x + Math.cos(t * 0.0001 + p.y) * 18,
      y + Math.sin(t * 0.0001 + p.x) * 18
    );
    ctx.stroke();
  }

  if (!armed && time - lastStimulus > 1200 + Math.random() * 2000) {
    armed = true;
    lastStimulus = time;
  }

  drawCount();
  t += 1;
  requestAnimationFrame(draw);
}
requestAnimationFrame(draw);

/* ===============================
   INPUT = OFFICIAL PARTICIPATION
================================ */
document.addEventListener("pointerup", () => {
  const now = performance.now();

  if (!counted && !IS_OWNER) {
    counted = true;
    fetch(`https://api.countapi.xyz/hit/${COUNT_NS}/${COUNT_KEY}`);
  }

  if (!armed) return;
  armed = false;

  const dt = now - lastStimulus;
  reactionWindow += dt <= reactionWindow ? -18 : 28;
  reactionWindow = Math.max(120, Math.min(700, reactionWindow));
});

/* ===============================
   CLEANUP ON LEAVE
================================ */
window.addEventListener("beforeunload", () => {
  if (counted && !IS_OWNER) {
    fetch(`https://api.countapi.xyz/hit/${COUNT_NS}/${COUNT_KEY}?amount=-1`);
  }
});

/* ===============================
   DISPLAY COUNT (SUBTLE)
================================ */
let lastFetch = 0;
let currentCount = 0;

async function drawCount() {
  const now = performance.now();
  if (now - lastFetch < 10000) return;
  lastFetch = now;

  try {
    const res = await fetch(
      `https://api.countapi.xyz/get/${COUNT_NS}/${COUNT_KEY}`
    );
    const data = await res.json();
    currentCount = data.value || 0;
  } catch {}

  ctx.save();
  ctx.fillStyle = "rgba(255,255,255,0.25)";
  ctx.font = "12px system-ui";
  ctx.fillText(`${currentCount} here`, 12, canvas.height - 12);
  ctx.restore();
}
</script>
</body>
</html>